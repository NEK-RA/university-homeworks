# Проект udi-cpp

## Выполнение

**Студент группы _ИКБО-18-22_, Налецкий Евгений.**

## Описание

Особого названия не придумывалось. `cpp` обозначает язык проекта, `udi` сокращение от UserLAnd Desktop Installer. Данный проект устанавливает различные окружения рабочего стола на платформе Linux, для последующего использования в связке с TightVNC сервером.

## Что побудило к разработке данного проекта

Упомянутый раннее [UserLAnd](https://github.com/CypherpunkArmory/UserLAnd) - приложение для ОС Android, создающее посредством [PRoot-контейнеров](https://wiki.archlinux.org/title/PRoot) максимально приближенную к Linux среду. PRoot в свою очередь это аналог `chroot` - это механизм, позволяющий сменить корневую дирректорию системы на указанную, однако, в отличие от `chroot`, не требующий привелегий администратора (root-доступ), благодаря чему он применим к устройствам на ОС Android, в которых у пользователя этих привелегий нет.

Особенностью проекта UserLAnd является то, что он предоставляет доступ в контейнеры двумя путями: по SSH (терминал) и по VNC (с графическим окружением).

Одна из текущих проблем ПО UserLAnd в том, что приложение предоставляет возможность установки различных окружений рабочего стола, но по каким-либо причинам делает это только для контейнеров на базе ОС Debian.

Экспериментальным путем было выяснено, что в контейнерах на базе других дистрибутивов окружения так же возможно установить и использовать вручную.

# Детальнее о udi-cpp

Не смотря на причину, по которой данный проект был написан, он не привязан к UserLAnd, т.е. подходит для использования и в обычных Linux дистрибутивах.

## Текущая реализация - минимальная

Чтобы успеть к крайнему сроку сдачи, проект был реализован в минимально возможном наборе поддерживаемых ОС:

- ОС на основе Debian с пакетным менеджером apt

- ОС на основе Alpine Linux с пакетным менеджером apk

Также, в силу спешки в `udi-cpp` добавлены только два окружения:

- Xfce4

- IceWM

Еще одним ограничением является то, что в текущей стадии проект предназначен для использования от имени администратора, т.е. пользователя `root` либо с использованием команды `sudo`.

Весь вывод производится на английском языке.

## Принцип работы

`udi-cpp` упрощает установку, выполняя рутинные операции вместо пользователя. В частности это:

- установка указанного окружения в систему

- удаление указанного окружения из системы

- установка в систему VNC-сервера TightVNC

- замена содержимого конфигурационного файла VNC сервера при переключении на указанное окружение

Программа не является интерактивной - все взаимодействие происходит посредством опций и аргументов по принципу 1 запуск - одна задача (за небольшим исключением), список которых представлен ниже:

- `--version` - отображает версию программы

- `--help` - отображает краткую справку о доступных аргументах и опциях

- `--list` - отображает список поддерживаемых в проекте окружений рабочего стола, причем если связанный с окружением файл обнаружен в системе, то соответствующее окружение будет помечено как установленное. На текущей стадии список включает в себя: `icewm`, `xfce`

- `--vnc` - данная опция преназначена для установки VNC-сервера TightVNC. По сути, именно эта опция расширяет спектр применения проекта со среды созданной в моб.приложении, до любых дистрибутивов, поддержка которых будет добавлена в проект. Данная опция также является тем самым "небольшим исключением", упомянутым выше, т.к. ее можно использовать вместе со следующими опциями, что в итоге даст 2 задачи на 1 запуск. Однако опция может использоваться и отдельно.

- `--add` - аргумент, предназначенный для установки окружения рабочего стола. В качестве значения принимает одно из значений, отображаемых при вызове с опцией `--list` (т.е. на текущий момент это `icewm`,` xfce` )

- `--remove` - аргумент, предназначенный для удаления окружения. В качестве значения принимает так же одно из окружений, по аналогии с опцией `--add`

- `--switch` - аргумент, который предназначен для переключения с одной среды на другую. Фактически заменяет конфигурационный файл. Допустимые значения те же, что и у `--add` с `--remove`

### Установка и удаление пакетов

Эта функциональность реализована благодаря использованию платформозависимой библиотеки `unistd.h`. В частности, оттуда использовалась подпрограмма для запуска процессов `popen`.

Данный метод при сравнительно простой реализации позволяет запустить необходимый процесс в системе, получить его вывод, а так же код завершения процесса. К сожалению напрямую использовать его в коде не получилось бы, т.к. в случае ошибок в запускаемых процессах, они пишут сообщения об ошибках в стандартный поток ошибок `stderr`, вывод которого `popen` не обрабатывается.

В конечном счете был сделан метод `exec` (в файле utils.cpp), который принимает на вход команду в виде строки, а также функцию-обработчик вывода. Внутри подпрограммы выполняется конкатенация строк: к команде добавляется строка, которая перенаправляет поток ошибок в поток вывода (возможность оболочек терминала в Linux), благодаря чему `exec` собирает и вывод выполняемого процесса, и его ошибки в случае возникновения таковых.

### Об использованных структурах

Глобальные переменные "это зло", поэтому, чтобы остаться в рамках процедурного программирования, была создана структура State, содержащая следующие сведения:

- обнаруженный пакетный менеджер

- команда для установки пакетов (с подстрокой для замены на пакеты)

- команда для удаления пакетов (с подстрокой для замены на пакеты)

- вектор строк содержащий список с путями до обнаруженных исполняемых файлов окружений, поддерживаемых в `udi-cpp`

Однако, в файле `utils.h` определены некоторые глобальные константы (такие как окружения рабочего стола, содержащий их список, строка версии и строка с помощью, выводимая по опции `--help`)

С целью получения максимально продуктивного результата запуска процессов была создана структура `ExecResult` (в файле utils.h), полями которой являются:

- код завершения процесса

- его вывод (включая ошибки)

- время выполнения процесса

Помимо этого, чтобы сохранить информацию об окружениях рабочего стола, была создана структура `DE`, в которой содержатся следующие сведения:

- строковое обозначение окружения, выводимое пользователю и используемое в качестве аргумента

- вектор строк, в котором содержится список пакетов для установки данного окружения

- содержимое конфигурационного файла VNC в виде строки (чтобы сервер знал какое окружение запускать для VNC-сессии)

- путь до исполняемого файла связанного с окружением, чтобы можно было обнаружить данное окружение если оно установлено

### Прочие моменты

Разбор переданных команде аргументов производится вручную - код представлен в `arguments.cpp`, в частности идет поиск в общем списке аргументов конкретных опций и аргументов, поддерживаемых программой. В случае обнаружения `--add`, `--remove`, `--switch` также проверяется следующий элемент из списка аргументов, и при наличии он считается значением соответствующего аргумента.

При обнаружении аргументов`--vnc`, `--add`, `--remove`, `--switch`  в силу ограничений текущей стадии реализации, выполняется проверка пользователя который запустил программу. В случае запуска от имени администратора, или другим пользователем системы, но с привилегиями администратора, система считает инициатором запуска пользователя `root`

При установке VNC-сервера вывод процесса установки отсутствует, т.к. установка занимает довольно короткое время.

При установке окружений рабочего стола вывод процесса установки присутствует, т.к. установка окружения может занять продолжительное время, следовательно необходимо показать пользователю что программа не зависла, а корректно работает.

Замена конфигурационного файла VNC сервера производится побычной перезаписью файла новым содержимым, которое хранится в одном из полей выше упомянутой структуры `DE`

Предыдущее содержимое помещается в соседний файл с суффиксом `.bkp`. Хранится только одна резервная копия.

Проверка существования каких-либо файлов в системе производится посредством библиотеки `filesystem`, которая требует поддержки стандарта C++17.

Также, с помощью данной библиотеки производится изменение разрешений некоторых файлов для обеспечения их корректной работы.

В процессе вывода в программе нигде не использовались интерактивные элементы (вроде возможностей curses) а так же символ `\r` возвращающий курсор в начало строки без переноса, так что вывод `udi-cpp` программы пригоден для чтения стронними средствами

# Сборка проекта

## Требования

**Необходимая ОС:** любая актуальная ОС на базе Linux. При разработке был использован Linux Mint 21 на основе Ubuntu 22.04.

**Система сборки:** `cmake` версии 3.18 или новее

**Компилятор:** любой, поддерживаемый системой сборки `cmake` компилятор с поддержкой стандарта C++17. При разработке был использован `g++` версии 10.2.1.

## Процесс сборки

1. Попав в папку с проектом, необходимо выполнить команду `cmake .`, которая сгенерирует всю необходимую информацию для сборки проекта

2. Выполнить сборку командой `cmake --build .`

3. В папке проекта появится готовый к использованию файл `udi-cpp`

## Описание исходников

### main.cpp

Содержит точку входа (`main`), а так же функции определения пакетного менеджера(`getManager`) и выдачи команд на установку/удаление пакетов (`installationCommand` и `deletionCommand` соответственно)

### utils.h + utils.cpp

Содержат:

- используемые структуры (`State`,`DE`, `ExecResult`)

- два перечисления (`actions` используемый для различия задач через switch-case и `packman` для обозначения пакетного менеджера)

- глобальные константы (`VERSION`, `HELP`, `pkgPlaceholder` которым обозначено место вставки пакетов в командах установки и удаления, информацию о средах в `ICEWM`, `XFCE` а так же их список в виде вектора `AVAILABLE_DESKTOPS`)

- Определяют следующие функции
  
  - `taskName` - возвращает читабельное название задачи (для вывода пользователю) на базе переданного значения из перечисления `actions`
  
  - `searchVectorStr` - функция поиска значения в векторе строк
  
  - `noProcessing` - функция не делающая ничего, применяющаяся чтобы не отображать вывод выполняемого процесса
  
  - `printLine` - функция отображающая заданную строку, применяется для отображения хода выполнения процесса
  
  - `exec` - функция, с помощью которой запускаются процессы в системе
  
  - `strReplace` - функция, заменяющая в строке `original` указанную подстроку `placeholder` на необходимое значение `content`
  
  - `packageManagement` - функция на базе `exec` которая предназначена чисто для запуска процесса установки/удаления пакетов 

### arguments.h + arguments.cpp

Содержат единственную функцию `parseArguments` которая ищет в переданных программе аргументах поддерживаемые аргументы и опции и в зависимости от находок возвращает вектор содержащий пары из действия `actions` и строки, в которой указывается значение аргумента (если тот такового требует)

### desktops.h + desktops.cpp

В данной части определены:

- `installDE` отвечающий за процесс установки окружения рабочего стола

- `removeDE` отвечающий за процесс удаления окружения рабочего стола

- `installVncServer` отвечающий за установку TightVNC

- `switchVncDesktop` отвечающий за изменение текущего VNC конфига

- `processOtherTasks` - запускает выше указанные функции, если значения аргументов переданных программе корректны. В связи с установкой/удалением пакетов именно эта часть требует root-доступ

Помимо этого здесь так же определены:

- `detectDesktops` - функция, обнаруживающая исполняемые файлы связанные с поддерживаемыми окружениями рабочего стола

- `desktopNameById`, `desktopIdByName` и `desktopIdByExecutable` - функции связанные с поиском нужной среды по переданному в них значению: чтобы отобразить имя по порядковому номеру, чтобы получить порядковый номер по названию и чтобы получить порядковый номер по связанному исполняемому файлу соответственно

- `getAvailableNames` - функция возвращающая названия всех поддерживаемых сред

- `printAvailableDesktops` - функция, срабатывающая при аргументе `--list`, использует `detectDesktops` чтобы при выводе списка сред так же отобразить какие из них установлены

# Демонстрация работы

1. нет процессов связанных с VNC

![udi-cpp-до установки нет процессов, связанных с VNC.png](./screenshots/1.%20udi-cpp-до%20установки%20нет%20процессов,%20связанных%20с%20VNC.png)

2. сборка проекта, черным цветом выделен исполняемый файл

![2. udi-cpp-сборка.png](./screenshots/2.%20udi-cpp-сборка.png)

3. вывод помощи по использованию

![udi-cpp-вывод помощи.png](./screenshots/3.%20udi-cpp-вывод%20помощи.png)

4. вывод списка доступных сред

![4. udi-cpp-список доступных окружений.png](./screenshots/4.%20udi-cpp-список%20доступных%20окружений.png)

5. начало установки `icewm` и TightVNC

![5. udi-cpp-vnc-add-icewm.png](./screenshots/5.%20udi-cpp-vnc-add-icewm.png)

6. конец установки

![6. udi-cpp-vnc-add-icewm-end.png](./screenshots/6.%20udi-cpp-vnc-add-icewm-end.png)

7. список сред после установки `icewm`

![7. udi-cpp-список доступных окружений после установки icewm.png](./screenshots/7.%20udi-cpp-список%20доступных%20окружений%20после%20установки%20icewm.png)

8. Переключение среды для VNC

![8. udi-cpp-switch.png](./screenshots/8.%20udi-cpp-switch.png)

9. Запуск VNC сервера скриптом, записанным в систему с помощью `udi-cpp`, а так же информация о среде в тестовой системе (окружение MATE)

![9. отработка скрипта запуска сервера, добавленного в систему программой udi-cpp.png](./screenshots/9.%20отработка%20скрипта%20запуска%20сервера,%20добавленного%20в%20систему%20программой%20udi-cpp.png)

10. Среда IceWM в окне VNC-клиента

![10. udi-cpp-установленный icewm.png](./screenshots/10.%20udi-cpp-установленный%20icewm.png)

11. Остановка VNC сервера скриптом, записанным в систему с помощью `udi-cpp`

![11. отработка скрипта остановки сервера, добавленного в систему программой udi-cpp.png](./screenshots/11.%20отработка%20скрипта%20остановки%20сервера,%20добавленного%20в%20систему%20программой%20udi-cpp.png)

12. Добавление в систему окружения Xfce4

![12. udi-cpp-add-xfce-start.png](./screenshots/12.%20udi-cpp-add-xfce-start.png)

13. Конец установки

![13. udi-cpp-add-xfce-end.png](./screenshots/13.%20udi-cpp-add-xfce-end.png)

14. При переключении используемой среды через `udi-cpp` предыдущая конфигурация сохраняется рядом в `xstartup.bkp`

![14. udi-cpp-backed-up previous xstartup.png](./screenshots/14.%20udi-cpp-backed-up%20previous%20xstartup.png)

15. Среда Xfce4 в окне VNC-клиента

![15. udi-cpp-установленный xfce.png](./screenshots/15.%20udi-cpp-установленный%20xfce.png)

16. Отработка удаления среды на примере IceWM

![16. udi-cpp-remove-icewm.png](./screenshots/16.%20udi-cpp-remove-icewm.png)

![17. udi-cpp-remove-icewm-end.png](./screenshots/17.%20udi-cpp-remove-icewm-end.png)
